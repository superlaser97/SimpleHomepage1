<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Homepage</title>
    <link rel="stylesheet" href="style.css">
    <script>
        // ---------------------
        // --- CONFIGURATION ---
        // ---------------------

        const icons = {
            "search": "M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z",
            "edit": "M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 00-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z",
            "delete": "M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z",
            "add": "M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z",
            "copy": "M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z",
            "check": "M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z",
            "clipboard": "M19 2h-4.18C14.4 1.15 13.55 0.5 12.5 0.5S10.6 1.15 10.18 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h13c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm7 18H6V4h2v2h9V4h2v16z",
"upload": "M9 16h6v-6h4l-8-8-8 8h4v6zm-4 2h14v2H5v-2z",
            "download": "M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z",
            "reset": "M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z",
            "file": "M6 2c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6H6zm7 7V3.5L18.5 9H13z",
            "folder": "M10 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z",
            "browser": "M19 4H5c-1.11 0-2 .9-2 2v12c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H5V8h14v10z"
        };
        
        const SAFE_COLORS = {
            sky: '#0ea5e9', red: '#ef4444', orange: '#f97316', green: '#22c55e', blue: '#3b82f6', indigo: '#6366f1',
            violet: '#8b5cf6', pink: '#ec4899', teal: '#14b8a6', rose: '#f43f5e', gray: '#6b7280', purple: '#a855f7'
        };
        const PREDEFINED_COLORS = Object.keys(SAFE_COLORS);

        // Legacy config: will be used only if nothing is in localStorage
        const encodedConfig = ``;

        // --- UTILITY FUNCTIONS ---
        function showMessage(title, message, type = 'info') {
            const existingBox = document.getElementById('message-box');
            if (existingBox) existingBox.remove();

            const messageBox = document.createElement('div');
            messageBox.id = 'message-box';
            messageBox.className = 'fixed top-5 left-1/2 -translate-x-1/2 w-full max-w-sm p-4 rounded-lg shadow-lg text-white z-[9999] transition-all duration-300 transform scale-95 opacity-0';
            
            const colors = {
                info: 'bg-sky-600', success: 'bg-green-600',
                warning: 'bg-orange-600', error: 'bg-red-600'
            };
            messageBox.classList.add(colors[type] || colors.info);
            messageBox.innerHTML = `
                <div class="flex items-start">
                    <div class="flex-grow">
                        <h4 class="font-bold">${title}</h4>
                        <p class="text-sm">${message}</p>
                    </div>
                    <button id="message-box-close" class="ml-4 p-1 rounded-full hover:bg-white/20">&times;</button>
                </div>
            `;
            document.body.appendChild(messageBox);
            
            setTimeout(() => {
                messageBox.classList.remove('scale-95', 'opacity-0');
            }, 10);

            const closeMessageBox = () => {
                messageBox.classList.add('opacity-0');
                setTimeout(() => messageBox.remove(), 300);
            };
            document.getElementById('message-box-close').onclick = closeMessageBox;
            setTimeout(closeMessageBox, 5000);
        }

        function showConfirmation(title, message, onConfirm) {
            const existingModal = document.getElementById('confirmation-modal');
            if (existingModal) existingModal.remove();

            const confirmationModal = document.createElement('div');
            confirmationModal.id = 'confirmation-modal';
            confirmationModal.className = 'edit-modal'; // Set base class, 'is-active' will be added later for transition
            
            confirmationModal.innerHTML = `
                <div class="edit-modal-content !max-w-sm">
                    <h2 class="text-lg font-bold mb-2 text-gray-800 dark:text-gray-100">${title}</h2>
                    <p class="text-sm mb-4 text-gray-600 dark:text-gray-300 whitespace-pre-line">${message}</p>
                    <div class="form-actions">
                        <button id="confirm-cancel" class="btn btn-secondary">Cancel</button>
                        <button id="confirm-ok" class="btn btn-primary bg-red-600 hover:bg-red-700">Confirm</button>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmationModal);

            // Add 'is-active' after a short delay to trigger the CSS transition
            setTimeout(() => {
                confirmationModal.classList.add('is-active');
            }, 10);

            const closeModal = () => {
                confirmationModal.classList.remove('is-active');
                // Wait for fade-out animation to finish before removing the element
                setTimeout(() => {
                    confirmationModal.remove();
                }, 300);
            };

            confirmationModal.addEventListener('click', (e) => { if (e.target === confirmationModal) closeModal(); });
            document.getElementById('confirm-cancel').onclick = closeModal;
            document.getElementById('confirm-ok').onclick = () => {
                onConfirm();
                closeModal();
            };
        }

        /**
         * Wraps all occurrences of a query in a text with <mark> tags for highlighting.
         * Case-insensitive and escapes regex special characters in the query.
         * @param {string} text The text to search within.
         * @param {string} query The search query.
         * @returns {string} The text as an HTML string with highlights.
         */
        function highlightText(text, query) {
            if (!query || !text) {
                return text; // Return original if no query or text
            }
            // Escape special regex characters to prevent errors
            const escapedQuery = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const regex = new RegExp(`(${escapedQuery})`, 'gi');
            return text.replace(regex, '<mark>$1</mark>');
        }

        function saveConfig() {
            const configToSave = {
                pageTitle: config.pageTitle,
                notes: config.notes,
                shortcuts: config.shortcuts,
                categoryConfig: config.categoryConfig,
            };
            try {
                const jsonString = JSON.stringify(configToSave);
                localStorage.setItem('homepageConfig', jsonString);
                console.log("Configuration saved to localStorage.");
            } catch (e) {
                console.error("Failed to save config to localStorage:", e);
                showMessage("Save Error", "Could not save configuration to local storage.", "error");
            }
        }

        function loadConfig() {
            const defaultConfig = {
                pageTitle: "My Homepage",
                notes: [{ title: "Welcome!", content: "This is your new homepage.\\nYour configuration is now saved automatically to your browser's local storage.\\n\\n- Use the controls in the top right to change the theme, style, or import/export your settings.\\n- Click the page title to edit it." }],
                shortcuts: [{ name: "Google", category: "Search", url: "https://www.google.com", icon: "google" }],
                categoryConfig: { "Search": { "color": "sky" }, "General": { "color": "gray" } }
            };

            // 1. Try loading from localStorage
            const savedConfig = localStorage.getItem('homepageConfig');
            if (savedConfig) {
                try {
                    const parsedConfig = JSON.parse(savedConfig);
                    return { ...defaultConfig, ...parsedConfig };
                } catch (e) {
                    console.error("Failed to parse config from localStorage, loading default. Error:", e);
                    showMessage("Config Error", "Could not load your saved configuration from local storage. Loading default page.", "error");
                }
            }

            // 2. Fallback to encodedConfig variable (for legacy support)
            if (encodedConfig && encodedConfig.trim() !== '') {
                try {
                    const decodedJson = atob(encodedConfig);
                    const parsedConfig = JSON.parse(decodedJson);
                    return { ...defaultConfig, ...parsedConfig };
                } catch (e) {
                    console.error("Failed to load or parse encodedConfig, loading default. Error:", e);
                    showMessage("Config Error", "Could not load your saved configuration from the HTML file. Loading default page.", "error");
                }
            }

            // 3. Return default if nothing else works
            return defaultConfig;
        }

        let config = loadConfig();
        config.icons = icons; 
        let { pageTitle, notes, shortcuts, categoryConfig } = config;

        // --- RENDER DYNAMIC FAVICON ---
        function renderFavicon() {
            const link = document.createElement('link');
            link.rel = 'icon';
            // FIXED: Replaced non-existent 'vercel' icon with the 'browser' icon
            const svgFavicon = `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'><path d='${icons.browser}'/></svg>`;
            link.href = `data:image/svg+xml,${encodeURIComponent(svgFavicon)}`;
            document.head.appendChild(link);
        }

        // --- RENDER FUNCTIONS ---
        function renderTitle() {
            document.getElementById('page-title').textContent = config.pageTitle;
            document.title = config.pageTitle;
        }

        // --- GREETING FUNCTION ---
        function renderGreeter() {
            const greeterContainer = document.getElementById('greeter');
            if (!greeterContainer) return;
            const now = new Date();
            const hour = now.getHours();
            let greeting = 'Welcome back.';
            if (hour >= 5 && hour < 12) { greeting = 'Good morning.'; } 
            else if (hour >= 12 && hour < 18) { greeting = 'Good afternoon.'; } 
            else { greeting = 'Good evening.'; }
            greeterContainer.textContent = greeting;
        }

        // --- DATE & CLOCK FUNCTIONS ---
        function renderDate() {
            const dateContainer = document.getElementById('date-display');
            if (!dateContainer) return;
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            dateContainer.textContent = now.toLocaleDateString(undefined, options);
        }

        function renderClock() {
            const clockContainer = document.getElementById('clock');
            if (!clockContainer) return;
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            clockContainer.innerHTML = `${hours}:${minutes}:<span class="opacity-60">${seconds}</span>`;
        }
        
        // --- CREATE UI ELEMENTS ---
        function createItemControls(item, type) {
            const controlsContainer = document.createElement('div');
            controlsContainer.className = 'absolute top-1 right-1 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity duration-300';

            const editBtn = document.createElement('button');
            editBtn.className = 'p-1 rounded-full bg-gray-300/50 dark:bg-gray-600/50 hover:bg-sky-500/50 dark:hover:bg-sky-400/50 cursor-pointer';
            editBtn.innerHTML = `<svg class="w-4 h-4 text-gray-700 dark:text-gray-200 pointer-events-none" fill="currentColor" viewBox="0 0 24 24"><path d="${icons.edit}"/></svg>`;
            editBtn.onclick = (e) => {
                e.preventDefault(); e.stopPropagation();
                if (type === 'shortcut') showShortcutModal(item);
                else showNoteEditModal(item);
            };

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'p-1 rounded-full bg-gray-300/50 dark:bg-gray-600/50 hover:bg-red-500/50 cursor-pointer';
            deleteBtn.innerHTML = `<svg class="w-4 h-4 text-gray-700 dark:text-gray-200 pointer-events-none" fill="currentColor" viewBox="0 0 24 24"><path d="${icons.delete}"/></svg>`;
            deleteBtn.onclick = (e) => {
                e.preventDefault(); e.stopPropagation();
                showConfirmation('Confirm Deletion', `Are you sure you want to delete this ${type}?`, () => {
                    if (type === 'shortcut') {
                        const index = config.shortcuts.indexOf(item);
                        if (index > -1) config.shortcuts.splice(index, 1);
                        renderShortcuts();
                    } else {
                        const index = config.notes.indexOf(item);
                        if (index > -1) config.notes.splice(index, 1);
                        renderNotes();
                    }
                    saveConfig();
                });
            };
            
            controlsContainer.appendChild(editBtn);
            controlsContainer.appendChild(deleteBtn);
            return controlsContainer;
        }
        
        function createShortcutElement(shortcut, query = '') {
            const container = document.createElement('div');
            container.className = 'relative group';

            const a = document.createElement('a');
            a.href = shortcut.url;
            a.target = '_blank';
            a.rel = 'noopener noreferrer';
            a.className = 'flex items-center gap-4 p-4 rounded-lg shadow-lg hover:shadow-cyan-500/10 hover:-translate-y-1 transition-all duration-300 text-gray-700 dark:text-gray-200 border border-gray-300/80 dark:border-gray-700/80 ' +
                          'bg-gray-100/50 dark:bg-gray-800/50 hover:bg-gray-200/60 dark:hover:bg-gray-700/80 ' +
                          'style-compact:gap-2 style-compact:p-2 style-compact:text-sm style-compact:bg-white/60 style-compact:dark:bg-gray-800/60';

            if (shortcut.icon && icons[shortcut.icon]) {
                const iconContainer = document.createElement('div');
                iconContainer.className = 'flex-shrink-0 w-6 h-6 style-compact:w-5 style-compact:h-5';
                const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                svg.setAttribute('viewBox', '0 0 24 24');
                svg.setAttribute('fill', 'currentColor');
                svg.className = 'text-gray-500 dark:text-gray-400 group-hover:text-black dark:group-hover:text-white transition-colors duration-300';
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('d', icons[shortcut.icon]);
                svg.appendChild(path);
                iconContainer.appendChild(svg);
                a.appendChild(iconContainer);
            }
            const textSpan = document.createElement('span');
            textSpan.innerHTML = highlightText(shortcut.name, query);
            textSpan.className = 'font-semibold style-compact:font-normal';
            a.appendChild(textSpan);

            const previewBox = document.getElementById('link-preview');
            if (previewBox) {
                a.addEventListener('mouseenter', (event) => {
                    previewBox.textContent = shortcut.url;
                    const rect = event.currentTarget.getBoundingClientRect();
                    previewBox.style.top = `${rect.bottom + window.scrollY + 8}px`;
                    previewBox.style.left = `${rect.left + rect.width / 2}px`;
                    previewBox.style.transform = 'translateX(-50%)';
                    previewBox.classList.remove('opacity-0');
                });

                a.addEventListener('mouseleave', () => {
                    previewBox.classList.add('opacity-0');
                });
            }
            
            container.appendChild(a);
            container.appendChild(createItemControls(shortcut, 'shortcut'));
            return container;
        }

        // --- MAIN RENDER FUNCTIONS ---
        function renderShortcuts(query = '') {
            const mainContainer = document.getElementById('shortcuts-container');
            mainContainer.innerHTML = '';
            
            const lowerCaseQuery = query.toLowerCase();
            const filteredShortcuts = config.shortcuts.filter(shortcut => 
                shortcut.name.toLowerCase().includes(lowerCaseQuery) ||
                (shortcut.category && shortcut.category.toLowerCase().includes(lowerCaseQuery))
            );

            if (filteredShortcuts.length === 0) {
                const message = query ? `No results found for "${query}".` : 'No shortcuts configured.';
                mainContainer.innerHTML = `<p class="text-gray-500 dark:text-gray-400 p-4 text-center col-span-full">${message}</p>`;
                return;
            }

            const groupedByCategory = filteredShortcuts.reduce((groups, shortcut) => {
                const category = shortcut.category || 'General';
                if (!groups[category]) groups[category] = [];
                groups[category].push(shortcut);
                return groups;
            }, {});

            let delay = 0;
            for (const category in groupedByCategory) {
                const configData = categoryConfig[category] || { color: 'gray' };
                const colorClass = configData.color;
                const categoryWrapper = document.createElement('div');
                categoryWrapper.className = `p-5 rounded-xl border border-gray-300/80 dark:border-gray-700/80 bg-gray-50/40 dark:bg-gray-800/40 backdrop-blur-sm shadow-2xl transition-all duration-300 style-compact:p-3 style-compact:rounded-lg style-compact:shadow-lg style-compact:bg-white/50 style-compact:dark:bg-gray-800/50`;

                categoryWrapper.style.animationDelay = `${delay}s`;
                delay += 0.1;

                const categoryHeader = document.createElement('div');
                // CHANGED: Added 'group' to enable group-hover for the new button
                categoryHeader.className = `group flex items-center gap-3 mb-4 border-b-2 pb-2`; 
                categoryHeader.style.borderColor = (SAFE_COLORS[colorClass] || '#6b7280') + '80';

                const categoryColorDot = document.createElement('div');
                categoryColorDot.className = `w-3 h-3 rounded-full flex-shrink-0`;
                categoryColorDot.style.backgroundColor = SAFE_COLORS[colorClass] || '#6b7280';

                const categoryTitle = document.createElement('h2');
                categoryTitle.innerHTML = highlightText(category, query);
                categoryTitle.className = 'text-xl font-bold text-gray-800 dark:text-gray-200 style-compact:text-lg style-compact:font-semibold';
                
                categoryHeader.appendChild(categoryColorDot);
                categoryHeader.appendChild(categoryTitle);

                // --- ADDED START: Direct Edit Button for Category ---
                if (category !== 'General') {
                    const editCategoryBtn = document.createElement('button');
                    editCategoryBtn.className = 'ml-2 p-1 rounded-full hover:bg-gray-500/20 opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer';
                    editCategoryBtn.title = `Edit "${category}" category`;
                    editCategoryBtn.innerHTML = `<svg class="w-4 h-4 text-gray-500 dark:text-gray-400" fill="currentColor" viewBox="0 0 24 24"><path d="${icons.edit}"/></svg>`;
                    
                    editCategoryBtn.onclick = (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        showCategoryModal(category); // The category name is in scope
                    };
                    categoryHeader.appendChild(editCategoryBtn);
                }
                // --- ADDED END ---

                categoryWrapper.appendChild(categoryHeader);

                const linksGrid = document.createElement('div');
                linksGrid.className = 'grid grid-cols-1 sm:grid-cols-2 gap-3 style-compact:gap-2';
                groupedByCategory[category].forEach(shortcut => {
                    linksGrid.appendChild(createShortcutElement(shortcut, query));
                });
                categoryWrapper.appendChild(linksGrid);
                mainContainer.appendChild(categoryWrapper);
            }
        }

        function parseNoteContent(rawContent, isPreview = false, query = '') {
             const lines = rawContent.split('\\n');
                let processedLines = [];
                let currentParagraph = [];
                let inList = false;
                const flushParagraph = () => {
                    if (currentParagraph.length > 0) {
                        const paragraphText = currentParagraph.join(' ').trim();
                        processedLines.push(`<p class="text-gray-600 dark:text-gray-300 mb-2 style-compact:mb-1 style-compact:text-sm">${highlightText(paragraphText, query)}</p>`);
                        currentParagraph = [];
                    }
                };
                const closeList = () => { if (inList) { processedLines.push('</ul>'); inList = false; } };
                lines.forEach(line => {
                    const headerMatch = line.match(/^(#{1,6})(.*?)\1?$/);
                    const listItemMatch = line.match(/^[\-\*]\s(.*)/);
                    if (headerMatch && headerMatch[2].trim() !== '') {
                        flushParagraph(); closeList();
                        const hashes = headerMatch[1];
                        const content = headerMatch[2].trim();
                        const headingLevel = Math.min(hashes.length + 1, 6);
                        let classes = 'font-bold';
                        if (isPreview) { classes += ' text-sm text-gray-500 dark:text-gray-400 mt-2 mb-1 style-compact:text-xs'; } 
                        else { classes += ` text-sky-600 dark:text-sky-300 ${['text-2xl','text-xl','text-lg','text-base'][headingLevel-2] || 'text-base'} mb-2`; }
                        processedLines.push(`<h${headingLevel} class="${classes}">${highlightText(content, query)}</h${headingLevel}>`);
                    } else if (listItemMatch) {
                        flushParagraph();
                        if (!inList) { processedLines.push('<ul class="list-disc list-inside space-y-1 pl-2 mb-2 style-compact:text-sm">'); inList = true; }
                        const listItemText = listItemMatch[1].trim();
                        processedLines.push(`<li class="text-gray-600 dark:text-gray-300">${highlightText(listItemText, query)}</li>`);
                    } else if (line.trim() === '') {
                        flushParagraph(); closeList();
                    } else {
                        closeList(); currentParagraph.push(line);
                    }
                });
                flushParagraph(); closeList();
                return processedLines.join('');
        }
        
        function renderNotes(query = '') {
            const notesContainer = document.getElementById('notes-container');
            const maxLines = 6;
            const lowerCaseQuery = query.toLowerCase();
            const filteredNotes = config.notes.filter(note => query === '' || (note.title && note.title.toLowerCase().includes(lowerCaseQuery)) || note.content.toLowerCase().includes(lowerCaseQuery) );
            if (filteredNotes.length === 0) {
                const message = query ? `No notes found for "${query}".` : 'No notes available.';
                notesContainer.innerHTML = `<p class="text-gray-500 dark:text-gray-400 p-4 text-center col-span-full">${message}</p>`;
                return;
            }
            notesContainer.innerHTML = '';
            let delay = 0;
            filteredNotes.forEach(note => {
                const noteCard = document.createElement('div');
                noteCard.className = 'relative group p-5 rounded-xl border border-gray-300/80 dark:border-gray-700/80 bg-gray-50/40 dark:bg-gray-800/40 backdrop-blur-sm shadow-2xl flex flex-col transition-all duration-300 style-compact:p-3 style-compact:rounded-lg style-compact:shadow-lg style-compact:bg-white/50 style-compact:dark:bg-gray-800/50';

                noteCard.style.animationDelay = `${delay}s`;
                delay += 0.1;
                if (note.title) {
                    const titleElement = document.createElement('h3');
                    titleElement.className = 'text-lg font-bold text-sky-600 dark:text-sky-300 mb-2 style-compact:text-base style-compact:mb-1';
                    titleElement.innerHTML = highlightText(note.title, query);
                    noteCard.appendChild(titleElement);
                }
                const contentElement = document.createElement('div');
                contentElement.className = 'text-gray-600 dark:text-gray-300 whitespace-pre-wrap style-compact:text-sm';
                noteCard.appendChild(contentElement);
                const lines = note.content.split('\\n');
                const isTruncated = lines.length > maxLines;
                const previewContent = isTruncated ? lines.slice(0, maxLines).join('\\n') + '\\n...' : note.content;
                contentElement.innerHTML = parseNoteContent(previewContent, true, query);
                noteCard.appendChild(createItemControls(note, 'note'));
                if (isTruncated) {
                    const readMore = document.createElement('span');
                    readMore.textContent = 'Read more';
                    readMore.className = 'text-sky-600 dark:text-sky-400 hover:text-sky-500 dark:hover:text-sky-300 font-semibold mt-auto pt-2 cursor-pointer style-compact:text-xs style-compact:pt-1';
                    noteCard.appendChild(readMore);
                }
                noteCard.classList.add('cursor-pointer', 'hover:border-sky-500/50', 'dark:hover:border-sky-500/50', 'hover:-translate-y-1');
                noteCard.addEventListener('click', (e) => {
                    if (e.target.closest('button')) return;
                    showNoteModal(
                        highlightText(note.title, query), 
                        parseNoteContent(note.content, false, query), 
                        note.content
                    );
                });
                notesContainer.appendChild(noteCard);
            });
        }
        
        // --- MODAL & EDITING LOGIC ---
        function showNoteModal(title, htmlContent, rawContent) {
            const modal = document.getElementById('note-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            modalTitle.innerHTML = title || 'Note';
            modalTitle.style.display = title ? 'block' : 'none';
            modalBody.innerHTML = htmlContent;
            modal.classList.add('is-active');
            document.body.style.overflow = 'hidden';
            const copyBtn = document.getElementById('modal-copy-btn');
            copyBtn.dataset.rawContent = rawContent;
        }

        function hideNoteModal() {
            const modal = document.getElementById('note-modal');
            modal.classList.remove('is-active');
            document.body.style.overflow = '';
        }

        function setupModal() {
            const modal = document.getElementById('note-modal');
            const closeBtn = document.getElementById('modal-close-btn');
            const copyBtn = document.getElementById('modal-copy-btn');
            const copyBtnText = document.getElementById('copy-btn-text');
            const copyBtnIcon = document.getElementById('copy-btn-icon');
            const copyBtnSuccessIcon = document.getElementById('copy-btn-success-icon');

            if (!modal || !closeBtn || !copyBtn) return;
            
            closeBtn.addEventListener('click', hideNoteModal);
            copyBtn.addEventListener('click', (e) => {
                if (copyBtnText.textContent === 'Copied!') return;
                const rawContent = e.currentTarget.dataset.rawContent;
                navigator.clipboard.writeText(rawContent).then(() => {
                    copyBtnText.textContent = 'Copied!';
                    copyBtnIcon.classList.add('hidden');
                    copyBtnSuccessIcon.classList.remove('hidden');
                    setTimeout(() => {
                        copyBtnText.textContent = 'Copy';
                        copyBtnIcon.classList.remove('hidden');
                        copyBtnSuccessIcon.classList.add('hidden');
                    }, 2000);
                }).catch(err => console.error('Failed to copy text: ', err));
            });
            modal.addEventListener('click', (event) => { if (event.target === modal) hideNoteModal(); });
        }
        
        let editingShortcut = null;
        let editingCategoryName = null;
        
        function renderCategorySelector(container, hiddenInput, selectedCategory = '') {
            container.innerHTML = ''; 
            const shortcutCategories = config.shortcuts.map(s => s.category);
            const configuredCategories = Object.keys(config.categoryConfig);
            const allCategories = [...new Set(['General', ...shortcutCategories, ...configuredCategories])].sort();
            
            allCategories.forEach(category => {
                if(!category) return; // Skip null/undefined categories
                const tagWrapper = document.createElement('div');
                tagWrapper.className = 'category-tag-wrapper';

                const tag = document.createElement('button');
                tag.type = 'button';
                tag.className = 'category-tag-btn';
                tag.textContent = category;
                tag.dataset.category = category;
                if (category === selectedCategory) { tag.classList.add('active'); }
                tagWrapper.appendChild(tag);
                
                if (category !== 'General') {
                    const controls = document.createElement('div');
                    controls.className = 'category-tag-controls';
                    const editBtn = document.createElement('button');
                    editBtn.type = 'button';
                    editBtn.className = 'category-edit-btn';
                    editBtn.innerHTML = `<svg viewBox="0 0 24 24"><path d="${icons.edit}"/></svg>`;
                    editBtn.onclick = (e) => { e.stopPropagation(); showCategoryModal(category); };
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.type = 'button';
                    deleteBtn.className = 'category-delete-btn';
                    deleteBtn.innerHTML = `<svg viewBox="0 0 24 24"><path d="${icons.delete}"/></svg>`;
                    deleteBtn.onclick = (e) => { e.stopPropagation(); deleteCategory(category); };

                    controls.appendChild(editBtn);
                    controls.appendChild(deleteBtn);
                    tagWrapper.appendChild(controls);
                }
                container.appendChild(tagWrapper);
            });

            hiddenInput.value = selectedCategory;

            const addCatButton = document.createElement('button');
            addCatButton.type = 'button';
            addCatButton.className = 'category-tag-btn add-new-btn';
            addCatButton.innerHTML = `<svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 24 24"><path d="${icons.add}"/></svg> New`;
            addCatButton.onclick = () => showCategoryModal();
            container.appendChild(addCatButton);
        }

        function deleteCategory(categoryToDelete) {
            showConfirmation('Delete Category', `Are you sure you want to delete the "${categoryToDelete}" category? All shortcuts in this category will be moved to "General".`, () => {
                config.shortcuts.forEach(shortcut => {
                    if (shortcut.category === categoryToDelete) { shortcut.category = 'General'; }
                });
                delete config.categoryConfig[categoryToDelete];
                const categoryContainer = document.getElementById('shortcut-category-selector');
                const categoryInput = document.getElementById('shortcut-category-input');
                const newSelectedCategory = categoryInput.value === categoryToDelete ? 'General' : categoryInput.value;
                renderCategorySelector(categoryContainer, categoryInput, newSelectedCategory);
                renderShortcuts();
                saveConfig();
            });
        }

        function renderIconSelector(container, hiddenInput, selectedIcon = '') {
            container.innerHTML = '';
            // ADDED: Define icons that are for internal UI use only
            const internalIcons = ['search', 'edit', 'delete', 'add', 'copy', 'check', 'clipboard', 'upload', 'download', 'reset'];
            
            // UPDATED: Filter the main icon list to exclude internal icons
            const iconNames = Object.keys(config.icons)
                                          .filter(icon => !internalIcons.includes(icon))
                                          .sort();

            const noneTag = document.createElement('button');
            noneTag.type = 'button';
            noneTag.className = 'icon-tag-btn none-btn';
            noneTag.textContent = 'None';
            noneTag.dataset.icon = '';
            if (selectedIcon === '' || !selectedIcon) { noneTag.classList.add('active'); }
            container.appendChild(noneTag);
            
            iconNames.forEach(iconName => {
                const tag = document.createElement('button');
                tag.type = 'button';
                tag.className = 'icon-tag-btn';
                tag.dataset.icon = iconName;
                tag.title = iconName;
                const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                svg.setAttribute('viewBox', '0 0 24 24');
                svg.setAttribute('fill', 'currentColor');
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('d', config.icons[iconName]);
                svg.appendChild(path);
                tag.appendChild(svg);
                if (iconName === selectedIcon) { tag.classList.add('active'); }
                container.appendChild(tag);
            });
            hiddenInput.value = selectedIcon || '';
        }

        function showCategoryModal(categoryName = null) {
            editingCategoryName = categoryName;
            const modal = document.getElementById('add-category-modal');
            const form = document.getElementById('add-category-form');
            const title = modal.querySelector('h2');
            const saveButton = modal.querySelector('button[type="submit"]');
            const nameInput = document.getElementById('new-category-name-input');
            const colorContainer = document.getElementById('new-category-color-selector');
            const colorInput = document.getElementById('new-category-color-input');
            
            form.reset();
            
            if (categoryName) {
                title.textContent = 'Edit Category';
                saveButton.textContent = 'Update Category';
                nameInput.value = categoryName;
                const currentColor = config.categoryConfig[categoryName]?.color || PREDEFINED_COLORS[0];
                renderColorSelector(colorContainer, colorInput, currentColor);
            } else {
                title.textContent = 'Add New Category';
                saveButton.textContent = 'Save Category';
                renderColorSelector(colorContainer, colorInput, PREDEFINED_COLORS[0]);
            }
            modal.classList.add('is-active');
        }

        function hideCategoryModal() {
            document.getElementById('add-category-modal').classList.remove('is-active');
            editingCategoryName = null;
        }
        
        function renderColorSelector(container, hiddenInput, selectedColor) {
            container.innerHTML = '';
            PREDEFINED_COLORS.forEach(colorName => {
                const tag = document.createElement('button');
                tag.type = 'button';
                tag.className = `color-tag-btn`;
                tag.style.backgroundColor = SAFE_COLORS[colorName];
                tag.dataset.color = colorName;
                tag.innerHTML = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="${config.icons.check}"/></svg>`;
                if (colorName === selectedColor) { tag.classList.add('active'); }
                container.appendChild(tag);
            });
            hiddenInput.value = selectedColor;
        }

        function showShortcutModal(shortcut = null) {
            editingShortcut = shortcut;
            const modal = document.getElementById('edit-shortcut-modal');
            const title = document.getElementById('edit-shortcut-modal-title');
            const categoryContainer = document.getElementById('shortcut-category-selector');
            const categoryInput = document.getElementById('shortcut-category-input');
            const iconContainer = document.getElementById('shortcut-icon-selector');
            const iconInput = document.getElementById('shortcut-icon-input');
            if (shortcut) {
                title.textContent = 'Edit Shortcut';
                document.getElementById('shortcut-name-input').value = shortcut.name;
                document.getElementById('shortcut-url-input').value = shortcut.url;
                renderCategorySelector(categoryContainer, categoryInput, shortcut.category);
                renderIconSelector(iconContainer, iconInput, shortcut.icon || '');
            } else {
                title.textContent = 'Add Shortcut';
                document.getElementById('edit-shortcut-form').reset();
                renderCategorySelector(categoryContainer, categoryInput, 'General');
                renderIconSelector(iconContainer, iconInput, '');
            }
            modal.classList.add('is-active');
            document.body.style.overflow = 'hidden';
        }

        function hideShortcutModal() {
            const modal = document.getElementById('edit-shortcut-modal');
            modal.classList.remove('is-active');
            document.body.style.overflow = '';
            editingShortcut = null;
        }

        let editingNote = null;
        function showNoteEditModal(note = null) {
            editingNote = note;
            const modal = document.getElementById('edit-note-modal');
            const title = document.getElementById('edit-note-modal-title');
            if (note) {
                title.textContent = 'Edit Note';
                document.getElementById('note-title-input').value = note.title || '';
                document.getElementById('note-content-input').value = note.content.replace(/\\n/g, '\n');
            } else {
                title.textContent = 'Add Note';
                document.getElementById('edit-note-form').reset();
            }
            modal.classList.add('is-active');
            document.body.style.overflow = 'hidden';
        }

        function hideNoteEditModal() {
            const modal = document.getElementById('edit-note-modal');
            modal.classList.remove('is-active');
            document.body.style.overflow = '';
            editingNote = null;
        }

        function setupEditing() {
            document.getElementById('page-title').addEventListener('blur', (e) => {
                const newTitle = e.target.textContent;
                if (newTitle !== config.pageTitle) {
                    config.pageTitle = newTitle;
                    document.title = newTitle;
                    saveConfig();
                    showMessage("Title Updated", "Page title has been saved.", "success");
                }
            });
            
            document.getElementById('edit-shortcut-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const updatedShortcut = {
                    name: document.getElementById('shortcut-name-input').value,
                    url: document.getElementById('shortcut-url-input').value,
                    category: document.getElementById('shortcut-category-input').value,
                    icon: document.getElementById('shortcut-icon-input').value
                };
                if (editingShortcut) { Object.assign(editingShortcut, updatedShortcut); } 
                else { config.shortcuts.push(updatedShortcut); }
                hideShortcutModal();
                renderShortcuts(document.getElementById('search-input').value);
                saveConfig();
            });
            document.getElementById('edit-shortcut-modal').addEventListener('click', (e) => { if(e.target === e.currentTarget) hideShortcutModal() });
            document.getElementById('shortcut-modal-cancel').addEventListener('click', hideShortcutModal);
            
            document.getElementById('shortcut-category-selector').addEventListener('click', (e) => {
                const clickedTag = e.target.closest('.category-tag-btn');
                if (!clickedTag || e.target.closest('.category-tag-controls')) return;
                document.getElementById('shortcut-category-input').value = clickedTag.dataset.category;
                const container = clickedTag.closest('.category-selector-container');
                const currentActive = container.querySelector('.category-tag-btn.active');
                if (currentActive) { currentActive.classList.remove('active'); }
                clickedTag.classList.add('active');
            });

            document.getElementById('shortcut-icon-selector').addEventListener('click', (e) => {
                const clickedTag = e.target.closest('.icon-tag-btn');
                if (!clickedTag) return;
                document.getElementById('shortcut-icon-input').value = clickedTag.dataset.icon;
                const container = clickedTag.parentElement;
                const currentActive = container.querySelector('.icon-tag-btn.active');
                if (currentActive) { currentActive.classList.remove('active'); }
                clickedTag.classList.add('active');
            });

            document.getElementById('add-category-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const newName = document.getElementById('new-category-name-input').value.trim();
                const newColor = document.getElementById('new-category-color-input').value;
                if (!newName) {
                    showMessage("Validation Error", "Category name cannot be empty.", "warning");
                    return;
                }

                if (editingCategoryName) {
                    config.categoryConfig[editingCategoryName].color = newColor;
                    if (editingCategoryName !== newName) {
                        config.shortcuts.forEach(sc => {
                            if (sc.category === editingCategoryName) { sc.category = newName; }
                        });
                        config.categoryConfig[newName] = config.categoryConfig[editingCategoryName];
                        delete config.categoryConfig[editingCategoryName];
                    }
                } else {
                    config.categoryConfig[newName] = { color: newColor };
                }
                
                hideCategoryModal();
                const categoryContainer = document.getElementById('shortcut-category-selector');
                const categoryInput = document.getElementById('shortcut-category-input');
                renderCategorySelector(categoryContainer, categoryInput, newName);
                renderShortcuts();
                saveConfig();
            });
            document.getElementById('new-category-color-selector').addEventListener('click', (e) => {
                const clickedTag = e.target.closest('.color-tag-btn');
                if (!clickedTag) return;
                document.getElementById('new-category-color-input').value = clickedTag.dataset.color;
                const container = clickedTag.parentElement;
                const currentActive = container.querySelector('.color-tag-btn.active');
                if (currentActive) { currentActive.classList.remove('active'); }
                clickedTag.classList.add('active');
            });
            document.getElementById('category-modal-cancel').addEventListener('click', hideCategoryModal);


            document.getElementById('edit-note-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const updatedNote = {
                    title: document.getElementById('note-title-input').value,
                    content: document.getElementById('note-content-input').value.replace(/\n/g, '\\n')
                };
                if (!updatedNote.title) delete updatedNote.title;
                if (editingNote) { Object.assign(editingNote, updatedNote); } 
                else { config.notes.push(updatedNote); }
                hideNoteEditModal();
                renderNotes(document.getElementById('search-input').value);
                saveConfig();
            });
            document.getElementById('edit-note-modal').addEventListener('click', (e) => { if(e.target === e.currentTarget) hideNoteEditModal() });
            document.getElementById('note-modal-cancel').addEventListener('click', hideNoteEditModal);
            
            document.getElementById('add-shortcut-btn').addEventListener('click', () => showShortcutModal());
            document.getElementById('add-note-btn').addEventListener('click', () => showNoteEditModal());
        }

        // --- SETUP FUNCTIONS ---
        function setupAddButtonIcons() {
            const addShortcutBtn = document.getElementById('add-shortcut-btn');
            const addNoteBtn = document.getElementById('add-note-btn');
            const createIcon = (iconPath) => {
                const svgNS = 'http://www.w3.org/2000/svg';
                const svg = document.createElementNS(svgNS, 'svg');
                svg.setAttribute('class', 'w-4 h-4 text-sky-600 dark:text-sky-300');
                svg.setAttribute('fill', 'currentColor');
                svg.setAttribute('viewBox', '0 0 24 24');
                const path = document.createElementNS(svgNS, 'path');
                path.setAttribute('d', iconPath);
                svg.appendChild(path);
                return svg;
            }
            const addIcon = createIcon(icons.add);
            addShortcutBtn.prepend(addIcon.cloneNode(true));
            addNoteBtn.prepend(addIcon.cloneNode(true));
        }

        function setupSearch() {
            const searchInput = document.getElementById('search-input');
            const searchBox = document.getElementById('search-box');
            if (!searchInput) return;
            searchInput.addEventListener('keyup', (e) => {
                const query = e.target.value;
                const isShortcutsActive = document.getElementById('tab-shortcuts').classList.contains('active-tab');
                if (isShortcutsActive) { renderShortcuts(query); } 
                else { renderNotes(query); }
            });
            searchInput.addEventListener('focus', () => searchBox.classList.add('border-sky-500'));
            searchInput.addEventListener('blur', () => searchBox.classList.remove('border-sky-500'));
        }

        function setupTabs() {
            const shortcutsTab = document.getElementById('tab-shortcuts');
            const notesTab = document.getElementById('tab-notes');
            const shortcutsContainer = document.getElementById('shortcuts-container');
            const notesContainer = document.getElementById('notes-container');
            const searchInput = document.getElementById('search-input');
            const addShortcutBtn = document.getElementById('add-shortcut-btn');
            const addNoteBtn = document.getElementById('add-note-btn');
            function updateTabState(activeTab) {
                const query = searchInput.value;
                if (activeTab === 'shortcuts') {
                    shortcutsTab.classList.add('active-tab'); notesTab.classList.remove('active-tab');
                    shortcutsContainer.classList.remove('hidden'); notesContainer.classList.add('hidden');
                    addShortcutBtn.classList.remove('hidden'); addNoteBtn.classList.add('hidden');
                    searchInput.placeholder = "Search shortcuts... (Press '/' to focus)";
                    renderShortcuts(query);
                } else {
                    notesTab.classList.add('active-tab'); shortcutsTab.classList.remove('active-tab');
                    notesContainer.classList.remove('hidden'); shortcutsContainer.classList.add('hidden');
                    addNoteBtn.classList.remove('hidden'); addShortcutBtn.classList.add('hidden');
                    searchInput.placeholder = "Search notes... (Press '/' to focus)";
                    renderNotes(query);
                }
            }
            updateTabState('shortcuts');
            shortcutsTab.addEventListener('click', () => updateTabState('shortcuts'));
            notesTab.addEventListener('click', () => updateTabState('notes'));
        }

        function setupThemeSwitcher() {
            const themeBtn = document.getElementById('theme-switcher');
            const sunIcon = document.getElementById('sun-icon');
            const moonIcon = document.getElementById('moon-icon');
            const applyTheme = (isDark) => {
                document.documentElement.classList.toggle('dark', isDark);
                sunIcon.classList.toggle('hidden', !isDark);
                moonIcon.classList.toggle('hidden', isDark);
            };
            themeBtn.addEventListener('click', () => {
                const isDarkMode = document.documentElement.classList.toggle('dark');
                localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
                applyTheme(isDarkMode);
            });
            const savedTheme = localStorage.getItem('theme');
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            applyTheme(savedTheme === 'dark' || (!savedTheme && systemPrefersDark));
        }

        function setupDisplayStyleSwitcher() {
            const styleBtn = document.getElementById('style-switcher');
            const styleText = document.getElementById('style-text');
            const container = document.querySelector('.container');
            const applyDisplayStyle = (isCompact) => {
                container.classList.toggle('style-compact', isCompact);
                styleText.textContent = isCompact ? 'Comfortable' : 'Compact';
                const currentQuery = document.getElementById('search-input').value;
                renderShortcuts(currentQuery);
                renderNotes(currentQuery);
            };
            styleBtn.addEventListener('click', () => {
                const isCompact = container.classList.toggle('style-compact');
                localStorage.setItem('displayStyle', isCompact ? 'compact' : 'comfortable');
                applyDisplayStyle(isCompact);
            });
            const savedDisplayStyle = localStorage.getItem('displayStyle');
            applyDisplayStyle(savedDisplayStyle === 'compact');
        }

        function setupConfigActions() {
            // Menu Buttons & Dropdowns
            const importMenuBtn = document.getElementById('import-menu-btn');
            const importMenuDropdown = document.getElementById('import-menu-dropdown');
            const exportMenuBtn = document.getElementById('export-menu-btn');
            const exportMenuDropdown = document.getElementById('export-menu-dropdown');
            
            // Submenu Items
            const exportClipboardBtn = document.getElementById('export-clipboard-btn');
            const exportFileBtn = document.getElementById('export-file-btn');
            const importClipboardBtn = document.getElementById('import-clipboard-btn');
            const importFileBtn = document.getElementById('import-file-btn');
            
            // Other elements
            const importFileInput = document.getElementById('import-file-input');
            const importModal = document.getElementById('import-config-modal');
            const resetBtn = document.getElementById('reset-config-btn');

            // --- MENU TOGGLE LOGIC ---
            const hideMenus = () => {
                importMenuDropdown.classList.add('hidden');
                exportMenuDropdown.classList.add('hidden');
            };

            importMenuBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                exportMenuDropdown.classList.add('hidden'); // Close other menu
                importMenuDropdown.classList.toggle('hidden');
            });

            exportMenuBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                importMenuDropdown.classList.add('hidden'); // Close other menu
                exportMenuDropdown.classList.toggle('hidden');
            });

            // Global listener to close menus when clicking elsewhere
            window.addEventListener('click', hideMenus);
            
            // --- EXPORT ---
            exportClipboardBtn.addEventListener('click', (e) => {
                e.preventDefault();
                hideMenus();
                const configToSave = {
                    pageTitle: config.pageTitle,
                    notes: config.notes,
                    shortcuts: config.shortcuts,
                    categoryConfig: config.categoryConfig,
                };
                const jsonString = JSON.stringify(configToSave);
                const base64String = btoa(unescape(encodeURIComponent(jsonString)));
                navigator.clipboard.writeText(base64String).then(() => {
                    showMessage('Export Successful', 'Configuration string copied to clipboard.', 'success');
                }).catch(err => {
                    showMessage('Export Failed', 'Could not copy configuration to clipboard.', 'error');
                    console.error('Failed to copy config: ', err);
                });
            });

            exportFileBtn.addEventListener('click', (e) => {
                e.preventDefault();
                hideMenus();
                const configToSave = {
                    pageTitle: config.pageTitle,
                    notes: config.notes,
                    shortcuts: config.shortcuts,
                    categoryConfig: config.categoryConfig,
                };
                const jsonString = JSON.stringify(configToSave, null, 4); // Pretty print
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'homepage-config.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showMessage('Export Successful', 'Configuration file is being downloaded.', 'success');
            });


            // --- IMPORT ---
            const showImportModal = () => { importModal.classList.add('is-active'); document.body.style.overflow = 'hidden'; };
            const hideImportModal = () => { importModal.classList.remove('is-active'); document.body.style.overflow = ''; };
            
            importClipboardBtn.addEventListener('click', (e) => {
                e.preventDefault();
                hideMenus();
                showImportModal();
            });

            importFileBtn.addEventListener('click', (e) => {
                e.preventDefault();
                hideMenus();
                importFileInput.click();
            });
            
            importFileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const parsedConfig = JSON.parse(e.target.result);
                         if (!parsedConfig.hasOwnProperty('pageTitle') || !parsedConfig.hasOwnProperty('shortcuts')) {
                             throw new Error("Invalid or incomplete configuration file.");
                         }
                        
                        config.pageTitle = parsedConfig.pageTitle || 'My Homepage';
                        config.notes = parsedConfig.notes || [];
                        config.shortcuts = parsedConfig.shortcuts || [];
                        config.categoryConfig = parsedConfig.categoryConfig || {};

                        saveConfig();
                        showMessage('Import Successful', 'Configuration has been loaded and saved.', 'success');
                        
                        renderTitle();
                        renderShortcuts();
                        renderNotes();
                    } catch (err) {
                        showMessage('Import Failed', 'The selected file is not a valid configuration file.', 'error');
                        console.error('Failed to import config from file:', err);
                    }
                };
                reader.readAsText(file);
                event.target.value = ''; // Reset input
            });

            // Import Modal Logic (for clipboard)
            document.getElementById('import-modal-cancel').addEventListener('click', hideImportModal);
            importModal.addEventListener('click', (e) => { if(e.target === e.currentTarget) hideImportModal(); });
            
            document.getElementById('import-config-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const importString = document.getElementById('import-config-string').value;
                if (!importString) {
                    showMessage('Import Error', 'Configuration string cannot be empty.', 'warning');
                    return;
                }
                try {
                    const decodedJson = atob(importString);
                    const parsedConfig = JSON.parse(decodeURIComponent(escape(decodedJson)));
                    
                    config.pageTitle = parsedConfig.pageTitle || 'My Homepage';
                    config.notes = parsedConfig.notes || [];
                    config.shortcuts = parsedConfig.shortcuts || [];
                    config.categoryConfig = parsedConfig.categoryConfig || {};

                    saveConfig();
                    hideImportModal();
                    showMessage('Import Successful', 'Configuration has been loaded and saved.', 'success');
                    
                    renderTitle();
                    renderShortcuts();
                    renderNotes();

                } catch (err) {
                    showMessage('Import Failed', 'The provided configuration string is invalid.', 'error');
                    console.error('Failed to import config:', err);
                }
            });

            // --- RESET ---
            resetBtn.addEventListener('click', () => {
                hideMenus();
                showConfirmation('Reset Configuration', 'Are you sure you want to reset all settings to their default values? This action cannot be undone.', () => {
                    localStorage.removeItem('homepageConfig');
                    showMessage('Configuration Reset', 'The page will now reload with default settings.', 'success');
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                });
            });
        }

        // --- INITIALIZATION ---
        window.onload = function() {
            renderTitle();
            renderFavicon();
            renderGreeter();
            renderDate();
            renderClock();
            setInterval(renderClock, 1000);
            setupAddButtonIcons();
            setupThemeSwitcher();
            setupDisplayStyleSwitcher();
            setupSearch();
            setupTabs();
            setupModal();
            setupEditing();
            setupConfigActions();
            window.addEventListener('keydown', (event) => {
                if (event.key === '/' && document.activeElement.tagName.toLowerCase() !== 'input' && document.activeElement.tagName.toLowerCase() !== 'textarea') {
                    event.preventDefault();
                    document.getElementById('search-input').focus();
                }
                if (event.key === 'Escape') {
                    if (document.getElementById('note-modal').classList.contains('is-active')) hideNoteModal();
                    if (document.getElementById('edit-shortcut-modal').classList.contains('is-active')) hideShortcutModal();
                    if (document.getElementById('edit-note-modal').classList.contains('is-active')) hideNoteEditModal();
                    if (document.getElementById('add-category-modal').classList.contains('is-active')) hideCategoryModal();
                    if (document.getElementById('import-config-modal').classList.contains('is-active')) document.getElementById('import-config-modal').classList.remove('is-active');
                }
            });
        };
    </script>
</head>
<body class="bg-gray-200 text-gray-800 dark:bg-gray-900 dark:text-white transition-colors duration-300">
    
    <div class="fixed top-4 right-4 flex items-center space-x-2 z-50">
        <button id="reset-config-btn" class="p-2 rounded-full bg-gray-500/20 hover:bg-gray-500/40 backdrop-blur-sm transition-colors cursor-pointer" title="Reset Configuration" aria-label="Reset Configuration">
            <svg class="w-5 h-5 text-gray-200" fill="currentColor" viewBox="0 0 24 24"><path d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"/></svg>
        </button>

        <div class="relative">
            <button id="import-menu-btn" class="p-2 rounded-full bg-gray-500/20 hover:bg-gray-500/40 backdrop-blur-sm transition-colors cursor-pointer" title="Import Configuration" aria-label="Import Configuration">
                <svg class="w-5 h-5 text-gray-200" fill="currentColor" viewBox="0 0 24 24"><path d="M9 16h6v-6h4l-8-8-8 8h4v6zm-4 2h14v2H5v-2z"/></svg>
            </button>
            <div id="import-menu-dropdown" class="absolute top-full right-0 mt-2 w-48 rounded-md shadow-lg py-1 z-10 hidden config-submenu">
                <a href="#" id="import-clipboard-btn" class="config-submenu-item">From Clipboard</a>
                <a href="#" id="import-file-btn" class="config-submenu-item">From File...</a>
            </div>
        </div>

        <div class="relative">
            <button id="export-menu-btn" class="p-2 rounded-full bg-gray-500/20 hover:bg-gray-500/40 backdrop-blur-sm transition-colors cursor-pointer" title="Export Configuration" aria-label="Export Configuration">
                <svg class="w-5 h-5 text-gray-200" fill="currentColor" viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
            </button>
             <div id="export-menu-dropdown" class="absolute top-full right-0 mt-2 w-48 rounded-md shadow-lg py-1 z-10 hidden config-submenu">
                <a href="#" id="export-clipboard-btn" class="config-submenu-item">To Clipboard</a>
                <a href="#" id="export-file-btn" class="config-submenu-item">To File...</a>
            </div>
        </div>

        <button id="theme-switcher" class="p-2 rounded-full bg-gray-500/20 hover:bg-gray-500/40 backdrop-blur-sm transition-colors cursor-pointer" aria-label="Toggle theme"><svg id="sun-icon" class="w-5 h-5 text-yellow-500 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg><svg id="moon-icon" class="w-5 h-5 text-gray-200 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg></button>
        <button id="style-switcher" class="p-2 rounded-full bg-gray-500/20 hover:bg-gray-500/40 backdrop-blur-sm transition-colors cursor-pointer" aria-label="Toggle display style"><span id="style-text" class="text-sm font-semibold">Compact</span></button>
    </div>

    <div class="absolute top-0 left-0 w-full h-full bg-gradient-to-br from-white/10 via-white/0 to-indigo-100/20 dark:from-gray-900 dark:via-gray-900 dark:to-indigo-900/40 -z-10"></div>
    
    <div class="container mx-auto p-4 sm:p-6 lg:p-8 transition-all duration-300 style-compact:p-2 style-compact:sm:p-4 style-compact:lg:p-6">
        <div class="mb-8 style-compact:mb-4"><div class="flex items-baseline gap-4"><h1 id="page-title" contenteditable="true" class="text-4xl font-bold text-left fade-in style-compact:text-3xl rounded-lg px-2 -mx-2 hover:bg-gray-500/10 focus:bg-gray-500/20 outline-none transition-colors" title="Click to edit"></h1><div id="clock" class="text-xl font-mono text-gray-500 dark:text-gray-400 style-compact:text-lg"></div></div><p id="greeter" class="text-gray-500 dark:text-gray-400 fade-in"></p><p id="date-display" class="text-gray-500 dark:text-gray-400 fade-in"></p></div>
        <div class="mb-6 style-compact:mb-4"><div id="search-box" class="relative flex items-center p-1 rounded-xl border border-gray-300/80 dark:border-gray-700/80 bg-white/40 dark:bg-gray-800/40 backdrop-blur-sm shadow-lg transition-colors"><div class="w-10 h-10 flex items-center justify-center flex-shrink-0"><svg class="w-6 h-6 text-gray-400 dark:text-gray-500" fill="currentColor" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"></path></svg></div><input id="search-input" type="text" placeholder="Search shortcuts... (Press '/' to focus)" class="w-full bg-transparent p-2 text-gray-800 dark:text-gray-200 focus:outline-none"></div></div>
        <div class="mb-4 flex items-center border-b border-gray-300/80 dark:border-gray-700/80"><button id="tab-shortcuts" class="tab-button px-4 py-2 text-sm font-semibold border-b-2 border-transparent transition-colors duration-300 text-gray-500 hover:text-gray-800 dark:hover:text-gray-200">Shortcuts</button><button id="tab-notes" class="tab-button px-4 py-2 text-sm font-semibold border-b-2 border-transparent transition-colors duration-300 text-gray-500 hover:text-gray-800 dark:hover:text-gray-200">Notes</button><div class="ml-auto"><button id="add-shortcut-btn" class="hidden cursor-pointer flex items-center gap-2 px-3 py-1.5 rounded-lg bg-sky-500/10 hover:bg-sky-500/20 dark:bg-sky-400/10 dark:hover:bg-sky-400/20 transition-colors"><span class="text-sm font-semibold text-sky-700 dark:text-sky-200">Add Shortcut</span></button><button id="add-note-btn" class="hidden cursor-pointer flex items-center gap-2 px-3 py-1.5 rounded-lg bg-sky-500/10 hover:bg-sky-500/20 dark:bg-sky-400/10 dark:hover:bg-sky-400/20 transition-colors"><span class="text-sm font-semibold text-sky-700 dark:text-sky-200">Add Note</span></button></div></div>
        <div id="shortcuts-container" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-3 mb-6 style-compact:gap-2 style-compact:mb-4"></div>
        <div id="notes-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 style-compact:gap-2"></div>
    </div>

    <div id="note-modal" class="edit-modal"><div class="edit-modal-content"><button id="modal-close-btn" class="absolute top-4 right-4 text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white text-3xl leading-none z-10 cursor-pointer"></button><div class="flex-grow overflow-y-auto" style="scrollbar-width: thin; scrollbar-color: #6b7280 transparent;"><div class="p-6"><h2 id="modal-title" class="text-2xl font-bold mb-4 text-gray-900 dark:text-white"></h2><div id="modal-body" class="text-gray-700 dark:text-gray-200 whitespace-pre-wrap"></div></div></div><div class="flex-shrink-0 pt-4 pb-6 px-6 border-t border-gray-200 dark:border-gray-700 flex justify-end"><button id="modal-copy-btn" class="flex items-center gap-2 px-4 py-2 rounded-md bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors cursor-pointer" aria-label="Copy content"><span id="copy-btn-text" class="text-sm font-medium text-gray-700 dark:text-gray-200">Copy</span><svg id="copy-btn-icon" class="w-5 h-5 text-gray-500 dark:text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg><svg id="copy-btn-success-icon" class="w-5 h-5 text-green-500 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></button></div></div></div>
    <div id="edit-shortcut-modal" class="edit-modal"><div class="edit-modal-content"><h2 id="edit-shortcut-modal-title" class="text-2xl font-bold mb-6 text-gray-800 dark:text-gray-100"></h2><form id="edit-shortcut-form"><div class="form-field"><label for="shortcut-name-input">Name</label><input id="shortcut-name-input" type="text" required></div><div class="form-field"><label for="shortcut-url-input">URL</label><input id="shortcut-url-input" type="url" required></div><div class="form-field"><label>Category</label><div id="shortcut-category-selector" class="category-selector-container"></div><input id="shortcut-category-input" type="hidden" required></div><div class="form-field"><label>Icon</label><div id="shortcut-icon-selector" class="icon-selector-container"></div><input id="shortcut-icon-input" type="hidden"></div><div class="form-actions"><button type="button" id="shortcut-modal-cancel" class="btn btn-secondary">Cancel</button><button type="submit" class="btn btn-primary">Save</button></div></form></div></div>
    <div id="edit-note-modal" class="edit-modal"><div class="edit-modal-content"><h2 id="edit-note-modal-title" class="text-2xl font-bold mb-6 text-gray-800 dark:text-gray-100"></h2><form id="edit-note-form"><div class="form-field"><label for="note-title-input">Title (Optional)</label><input id="note-title-input" type="text"></div><div class="form-field"><label for="note-content-input">Content</label><textarea id="note-content-input" required></textarea></div><div class="form-actions"><button type="button" id="note-modal-cancel" class="btn btn-secondary">Cancel</button><button type="submit" class="btn btn-primary">Save</button></div></form></div></div>
    <div id="add-category-modal" class="edit-modal"><div class="edit-modal-content"><h2 class="text-2xl font-bold mb-6 text-gray-800 dark:text-gray-100">Add New Category</h2><form id="add-category-form"><div class="form-field"><label for="new-category-name-input">Category Name</label><input id="new-category-name-input" type="text" required></div><div class="form-field"><label>Color</label><div id="new-category-color-selector" class="color-selector-container"></div><input id="new-category-color-input" type="hidden" required></div><div class="form-actions"><button type="button" id="category-modal-cancel" class="btn btn-secondary">Cancel</button><button type="submit" class="btn btn-primary">Save Category</button></div></form></div></div>
    <div id="import-config-modal" class="edit-modal"><div class="edit-modal-content"><h2 class="text-2xl font-bold mb-6 text-gray-800 dark:text-gray-100">Import Configuration</h2><form id="import-config-form"><div class="form-field"><label for="import-config-string">Paste Configuration String</label><textarea id="import-config-string" required placeholder="Paste your exported configuration string here..."></textarea></div><div class="form-actions"><button type="button" id="import-modal-cancel" class="btn btn-secondary">Cancel</button><button type="submit" class="btn btn-primary">Load Configuration</button></div></form></div></div>

    <div id="link-preview" class="fixed pointer-events-none z-50 rounded-lg bg-gray-800 px-3 py-1.5 text-sm font-medium text-white shadow-lg transition-opacity duration-200 opacity-0" role="tooltip"></div>
    <input type="file" id="import-file-input" class="hidden" accept=".json,application/json">
</body>
</html>